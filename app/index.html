<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>VecGeo Vector Geospatial Dataset Viewer</title>
  <meta content="A web-based vector geospatial dataset viewer." name="description">

  <!-- Favicon -->
  <link
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><polygon points='50,10 90,90 10,90' fill='%234a9eff'/></svg>"
    rel="icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link crossorigin href="https://fonts.gstatic.com" rel="preconnect">
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
    rel="stylesheet">

  <!-- Leaflet CSS -->
  <link crossorigin="" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" rel="stylesheet">

  <!-- App CSS -->
  <link href="assets/css/styles.css" rel="stylesheet">

  <!-- Import Map for ES modules -->
  <script type="importmap">
    {
        "imports": {
            "apache-arrow": "https://cdn.jsdelivr.net/npm/apache-arrow@14.0.2/+esm"
        }
    }
  </script>
</head>

<body>
<!-- Error Banner -->
<div aria-live="polite" class="error-banner hidden" id="errorBanner" role="alert">
  <span id="errorMessage"></span>
  <button aria-label="Close" id="errorCloseBtn" title="Close">×</button>
</div>

<!-- App Container -->
<div class="app-container">

  <!-- Header -->
  <header class="app-header">
    <div class="header-left">
      <h1>VecGeo Viewer</h1>
    </div>
    <div class="header-right">
      <button aria-label="View GitHub Repository"
              class="icon-btn"
              onclick="window.open('https://github.com/CogitatorTech/vecgeo-viewer', '_blank')" title="GitHub Repository">
        <svg fill="currentColor" height="20" viewBox="0 0 24 24" width="20">
          <path
            d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
        </svg>
      </button>
      <button aria-label="Help" class="icon-btn" onclick="toggleHelp()" title="Help & Shortcuts">
        <svg fill="none" height="20" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="20">
          <circle cx="12" cy="12" r="10"/>
          <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
          <line x1="12" x2="12.01" y1="17" y2="17"/>
        </svg>
      </button>
      <button aria-label="Toggle Theme" class="icon-btn" onclick="toggleTheme()" title="Toggle Theme">
        <svg fill="none" height="20" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="20">
          <circle cx="12" cy="12" r="5"/>
          <line x1="12" x2="12" y1="1" y2="3"/>
          <line x1="12" x2="12" y1="21" y2="23"/>
          <line x1="4.22" x2="5.64" y1="4.22" y2="5.64"/>
          <line x1="18.36" x2="19.78" y1="18.36" y2="19.78"/>
          <line x1="1" x2="3" y1="12" y2="12"/>
          <line x1="21" x2="23" y1="12" y2="12"/>
          <line x1="4.22" x2="5.64" y1="19.78" y2="18.36"/>
          <line x1="18.36" x2="19.78" y1="5.64" y2="4.22"/>
        </svg>
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Control Panel -->
    <aside class="control-panel" id="controlPanel">
      <div class="panel-section">
        <h3>Load Dataset</h3>
        <div class="file-upload-area" id="fileUploadArea">
          <input accept=".geojson,.json,.zip,.shp,.parquet,.geoparquet" id="fileInput" multiple
                 type="file">
          <label class="file-upload-label" for="fileInput">
            <svg fill="none" height="24" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"
                 width="24">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="17,8 12,3 7,8"/>
              <line x1="12" x2="12" y1="3" y2="15"/>
            </svg>
            <span>Drop files or click to upload</span>
            <small>GeoJSON, Shapefile (Zip), or Parquet</small>
          </label>
        </div>
      </div>

      <div class="panel-section" id="dataControls" style="display: none;">
        <h3>Visualization Settings</h3>

        <div class="control-group">
          <label for="columnSelect">Color by Column</label>
          <select id="columnSelect" onchange="App.setColumn(this.value)">
            <option value="">-- Select column --</option>
          </select>
        </div>

        <div class="control-group">
          <label for="colormapSelect">Colormap</label>
          <select id="colormapSelect" onchange="App.setColormap(this.value)">
            <option value="viridis">Viridis</option>
            <option value="plasma">Plasma</option>
            <option value="turbo">Turbo</option>
            <option value="cividis">Cividis</option>
            <option value="spectral">Spectral</option>
            <option value="blues">Blues</option>
            <option value="reds">Reds</option>
          </select>
        </div>

        <div class="control-group">
          <label for="basemapSelect">Basemap</label>
          <select id="basemapSelect" onchange="App.setBasemap(this.value)">
            <option value="dark">Dark (CARTO)</option>
            <option value="light">Light (CARTO)</option>
            <option value="osm">OpenStreetMap</option>
            <option value="satellite">Satellite (ESRI)</option>
            <option value="terrain">Terrain (Stamen)</option>
            <option value="none">No Basemap</option>
          </select>
        </div>
      </div>

      <div class="panel-section" id="sqlSection" style="display: none;">
        <h3>Filter Objects Using SQL</h3>
        <div class="control-group">
          <textarea id="sqlInput" placeholder="SELECT * FROM data WHERE LIMIT 100" rows="3"></textarea>
          <div class="btn-row">
            <button class="btn btn-primary" onclick="App.runSQL()">Run Query</button>
            <button class="btn btn-secondary" onclick="App.resetFilter()">Reset Focus</button>
          </div>
          <div class="btn-row"
               style="margin-top: 12px; border-top: 1px solid var(--border-color); padding-top: 12px;">
            <button class="btn btn-secondary" onclick="App.showDataViewer()" style="width: 100%">
              <svg fill="none" height="16" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"
                   viewBox="0 0 24 24" width="16">
                <rect height="18" rx="2" ry="2" width="18" x="3" y="3"/>
                <line x1="3" x2="21" y1="9" y2="9"/>
                <line x1="9" x2="9" y1="21" y2="9"/>
              </svg>
              View (Filtered) Data
            </button>
          </div>
          <div class="btn-row" style="margin-top: 8px;">
            <button class="btn btn-secondary" onclick="App.exportData()" style="width: 100%">
              <svg fill="none" height="16" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"
                   viewBox="0 0 24 24" width="16">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" x2="12" y1="15" y2="3"/>
              </svg>
              Export (Filtered) Data
            </button>
          </div>
        </div>
      </div>

      <div class="panel-section" id="legendSection" style="display: none;">
        <h3>Color Legend</h3>
        <div id="legendContent"></div>
      </div>

      <div class="panel-section">
        <h3>Keyboard Shortcuts</h3>
        <div class="shortcuts-mini">
          <span><kbd>+</kbd><kbd>-</kbd> Zoom</span>
          <span><kbd>←→↑↓</kbd> Pan</span>
          <span><kbd>[</kbd><kbd>]</kbd> Columns</span>
          <span><kbd>M</kbd> Colormap</span>
          <span><kbd>B</kbd> Basemap</span>
          <span><kbd>R</kbd> Reset Focus</span>
        </div>
      </div>
    </aside>

    <!-- Map Container -->
    <div class="map-wrapper">
      <div id="map"></div>

      <!-- Loading Overlay -->
      <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p id="loadingText">Loading...</p>
      </div>

      <!-- Welcome Message (shown when no data loaded) -->
      <div class="welcome-overlay" id="welcomeOverlay">
        <div class="welcome-content">
          <h2>Welcome to VecGeo Viewer</h2>
          <p>Drag and drop a file to get started, or use the upload button.</p>
          <div class="supported-formats">
            <span class="format-badge">GeoJSON</span>
            <span class="format-badge">Shapefile (zip)</span>
            <span class="format-badge">Parquet</span>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Status Bar -->
  <footer class="status-bar" id="statusBar">
    <div class="status-left">
      <span id="featureCount">No data loaded</span>
    </div>
    <div class="status-center">
      <span id="currentColumn">—</span>
    </div>
    <div class="status-right">
      <span id="zoomLevel">Zoom: —</span>
    </div>
  </footer>
</div>

<!-- Drop Overlay -->
<div class="drop-overlay" id="dropOverlay">
  <div class="drop-content">
    <svg fill="none" height="64" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="64">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
      <polyline points="17,8 12,3 7,8"/>
      <line x1="12" x2="12" y1="3" y2="15"/>
    </svg>
    <p>Drop file to load</p>
  </div>
</div>

<!-- Help Modal -->
<div aria-hidden="true" class="modal-overlay" id="helpModal" onclick="handleModalClick(event)" role="dialog">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Help</h2>
      <button aria-label="Close" class="close-btn" onclick="toggleHelp()">×</button>
    </div>
    <div class="modal-body">
      <div class="help-section">
        <h3>Supported Formats</h3>
        <ul>
          <li><strong>GeoJSON</strong> (.geojson, .json) — Standard vector format</li>
          <li><strong>Shapefile</strong> (.zip containing .shp, .dbf, .prj) — ESRI format</li>
          <li><strong>Parquet</strong> (.parquet, .geoparquet) — Columnar format with geometry</li>
        </ul>
      </div>
      <div class="help-section">
        <h3>Keyboard Shortcuts</h3>
        <table class="shortcuts-table">
          <tr>
            <td><kbd>+</kbd> / <kbd>-</kbd></td>
            <td>Zoom in / out</td>
          </tr>
          <tr>
            <td><kbd>↑</kbd><kbd>↓</kbd><kbd>←</kbd><kbd>→</kbd></td>
            <td>Pan the map</td>
          </tr>
          <tr>
            <td><kbd>[</kbd> / <kbd>]</kbd></td>
            <td>Previous / Next column</td>
          </tr>
          <tr>
            <td><kbd>M</kbd></td>
            <td>Cycle colormap</td>
          </tr>
          <tr>
            <td><kbd>B</kbd></td>
            <td>Toggle basemap</td>
          </tr>
          <tr>
            <td><kbd>R</kbd></td>
            <td>Reset view (fit to data)</td>
          </tr>
          <tr>
            <td><kbd>?</kbd> / <kbd>H</kbd></td>
            <td>Toggle this help</td>
          </tr>
        </table>
      </div>
      <div class="help-section">
        <h3>SQL Filtering</h3>
        <p>Use DuckDB SQL to filter and transform your data:</p>
        <pre><code>SELECT * FROM data WHERE population > 1000000
SELECT name, area FROM data ORDER BY area DESC LIMIT 10
SELECT *, pop/area AS density FROM data</code></pre>
      </div>
    </div>
    <div class="modal-footer">
      <p>VecGeo Viewer v0.2.0</a></p>
    </div>
  </div>
</div>

<!-- Data Viewer Modal -->
<div aria-hidden="true" class="modal-overlay" id="dataViewerModal" onclick="handleModalClick(event)" role="dialog">
  <div class="modal-content modal-large">
    <div class="modal-header">
      <h2>Data Viewer</h2>
      <div class="data-viewer-controls">
        <input id="dataSearchInput" onkeyup="App.filterDataTable(this.value)" placeholder="Search..."
               type="text">
        <span id="dataRowCount">0 rows</span>
      </div>
      <button aria-label="Close" class="close-btn" onclick="App.hideDataViewer()">x</button>
    </div>
    <div class="modal-body data-viewer-body">
      <div class="table-container">
        <table class="data-table" id="dataTable">
          <thead id="dataTableHead"></thead>
          <tbody id="dataTableBody"></tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer data-viewer-footer">
      <div class="pagination">
        <button class="btn btn-secondary" id="dataPrevBtn"
                onclick="App.dataTablePrevPage()">Previous
        </button>
        <span id="dataPageInfo">Page 1 of 1</span>
        <button class="btn btn-secondary" id="dataNextBtn" onclick="App.dataTableNextPage()">Next</button>
      </div>
      <div class="page-size">
        <label>Rows per page:</label>
        <select id="dataPageSize" onchange="App.setDataTablePageSize(this.value)">
          <option value="25">25</option>
          <option selected value="50">50</option>
          <option value="100">100</option>
          <option value="500">500</option>
        </select>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<!-- Leaflet -->
<script crossorigin=""
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Shapefile Parser -->
<script src="https://unpkg.com/shpjs@4.0.4/dist/shp.min.js"></script>

<!-- Chroma.js for color scales -->
<script src="https://unpkg.com/chroma-js@2.4.2/chroma.min.js"></script>

<!-- Proj4js for coordinate transformation -->
<script src="https://unpkg.com/proj4@2.9.2/dist/proj4.js"></script>


<!-- DuckDB WASM - ESM with global assignment -->
<script type="module">
  try {
    // Try local first
    const duckdbModule = await import('./assets/vendor/duckdb/duckdb-browser.mjs');
    window.duckdb = duckdbModule;
    console.log('[DuckDB] Loaded local module');
  } catch (e) {
    console.warn('[DuckDB] Local module failed, trying CDN:', e);
    try {
      // Fallback to CDN
      const duckdbModule = await import('https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.28.0/dist/duckdb-browser.mjs');
      window.duckdb = duckdbModule;
      console.log('[DuckDB] Loaded CDN module');
    } catch (e2) {
      console.error('[DuckDB] Failed to load from both local and CDN:', e2);
    }
  }
</script>

<!-- App (ES Module) -->
<script src="assets/js/app.js" type="module"></script>
</body>

</html>
